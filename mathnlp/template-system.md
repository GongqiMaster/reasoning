## 句模系统

建议阅读顺序是把整个流程大致理解后，再来看这部分。

句模系统并不是必须的，很多简单的句子并不需要添加模板。模板只是为了把复杂的句子拆成简单的句子，使得NER的流程更加精确。思路来自一期项目中的模板系统和章文杰提供的思路。

python版本源码位置：mathnerdevelop/utils/template_util.py

python版本配置文件位置：mathnerdevelop/utils/nlp_templates/

### 具体思想

既然要拆分句子，就需要提取到内部的一些特征，具体表现就是实体。怎么匹配？很容易想到正则表达式`^...$`。但编写大量类似的正则表达式会带来痛苦，句模系统就是封装了一套新的、规则更加简洁的、基于数学实体类别的新的正则规则，能够显著减少重复的工作量。

比如举出两个例子：
```
椭圆$O$的左焦点和右焦点分别是$A$、$B$
双曲线$S$的左焦点和右焦点分别是$A$、$B$
椭圆$O$的上顶点和下顶点分别是$A$、$B$
```

等会会说这句话会拆分成什么样子以及为什么要拆分。先看句子结构，主语`双曲线`、`椭圆`其实可以归类为`圆锥曲线`，类似父类和子类的关系。`左焦点`、`右焦点`、`上顶点`、`下顶点`其实都可以算作`点`的子类，也可以这样归类。如果能使用这种归类后的实体来编写正则模板，工作量一下子就降下来了。正则当中的`|`符号就能帮助办到这个。

再看另一种情况，因为是全句匹配`^...$`，所以一些不重要词的细微差别就会导致匹配失败，所以也需要用这种“归类”的思想来减少工作量。比如：
```
是|为|等于|都是|都为... -> 都可以归类为 "IS" 的意思
和|与|、|,|且与... -> 都可以归类为 "AND" 的意思
```

上面这两种情况一样，都是用`|`符号来办到的，但也有区别，**即第一种情况的得到实体要映射回拆出来的多个小的正则表达式中**，而对第二种情况，就不需要做这部分工作了，因为都是一个意思，也不会影响后续的理解。

后面会依据这种思想来设计。

### 使用场景

再说下使用场景，如果你完整阅读完除了本章之外的其他章节，且对整个NLP有了大致的了解后（其实并不复杂），并测试过几个结构比较复杂的句子，可能就知道为什么要使用这样一个句模系统了。

言归正传，目前需要编写模板的句子，有下面几种情况：

1. 多个并列结构需要对应，且中间有一阶谓词和谓词的引用计数，会导致对应错误的情况；
2. 需要引入多个实体，但是句子中省略了，并没有表现出来的情况；
3. 句子非常不规范的情况（省略表述、混乱表述等）；
4. 句子非常复杂，现有逻辑无能为力的情况。

一个一个来分析一下。

#### 情况1：多并列结构拆分

```
例1：已知椭圆$C$的左焦点和右焦点坐标分别是$A$、$B$
```

这里面有两个并列结构：
```
结构1：左焦点和右焦点
结构2：$A$、$B$
```

之间的谓词逻辑是产生类型递进的依赖。但之间仅仅有一个一阶谓词，由于目前系统中的类型递进部分的设计原因，一个谓词只能使用一次，对并列结构的检测计数不好实现。更重要的原因是，由于类型递进的顺序是`由两侧向中间检测递进`，会导致`B`成为`左焦点`，而不是`A`。

综上，对于带有并列结构的，且有一阶谓词在中间的，需要使用拆分成多个简单句：
```
简单句1：已知椭圆$C$的左焦点坐标是$A$
简单句2：已知椭圆$C$的右焦点坐标是$B$
```

注：原句里面也隐含了一个坐标，类似情况2的说明，可以自己补全，不过不是很重要。

#### 情况2：隐式多实体引入

```
例1：且直线$AP$与$BP$的斜率之积等于$-(1/3)$
例2：$A$与$B$的横坐标之和为$2$
```

这两句话如果细品，会发现里面其实少了东西，应该是这样：
```
例1：且直线$AP$的斜率与$BP$的斜率之积等于$-(1/3)$
例2：$A$的横坐标与$B$的横坐标之和为$2$
```

NER系统会对缺失的英文实体做引入变量的操作，如果放任这样的句子不管，最终生成出来的实体会缺失，表现到图谱上就会少节点，标注关系也不方便。

实际上这种情况需要引入多个实体，只是人的省略习惯带来了这样的书写，这种情况一般需要编写对应的模板。

因为之间不涉及谓词，所以对应的子模板一般也只有一个。

#### 情况3：句子非常不规范

句子不规范的情况有很多种，很多情况使用同义词替换可以解决。但是非常不规范的话，可能需要使用模板。模板非常灵活，这部分不详细举例。

#### 情况4：句子非常复杂

多数句子非常复杂的情况指的就是嵌套的谓词逻辑结构和多个并列结构，可能需要使用模板。模板非常灵活，这部分不详细举例。

### 模板编写规则

编写模板需要阅读以下几个文件：
 - 正则配置文件：mathnerdevelop/utils/nlp_templates/patterns.ini
 - 模板配置文件：mathnerdevelop/utils/nlp_templates/template.ini
 - README：mathnerdevelop/utils/nlp_templates/README.md

具体编写方式参考里面的说明即可，原则上不再赘述。主要有几点需要注意：

1. 自定义正则主要有三种写法：`%...%`、`#...#`、`@...@`，每一种的用法见上面的说明；
2. `@...@`在编写正则时不需要添加，`#...#`不要添加到subRegexList中的子句当中；
3. 原则上也可以写标准的正则表达式，但是需要保证正确性；
4. 需要在启动时检查所有正则的语法，目前还没有添加。  